---
title: "OFC muscimol + ACx ephys - Analyses (Figs 5-6, S5-6)"
author: "Matheus Macedo-Lima"
date: "2024-05-29"
output: html_document
---

# Load libraries and data from preprocessing pipeline (ACx_ephys_preprocessing.Rmd)
Uncomment chunk below if the second block of code has been run previously and does not need modifications
```{r echo=TRUE}

# load('./Data/ACx_ephys/ACx_ephys_analyses_env.RData')
# 
# library(ggplot2)
# library(dplyr)
# library(tidyr)
# # install.packages(c('remotes', 'TMB'))
# # remotes::install_github("glmmTMB/glmmTMB/glmmTMB", build_vignettes=FALSE)
# library(glmmTMB)
# library(DHARMa)
# library(car)
# library(reshape2)
# library(emmeans)
# library(rcompanion)
# # Create the notin operator
# `%notin%` <- Negate(`%in%`)
# 
# # Some global plot parameters if modification is needed.
# source('./r_theme.r', echo=F)
# theme_set(theme_mml(base_size = 20))
# LINE_THICKNESS = 1
# ERRORBAR_THICKNESS = LINE_THICKNESS/2
# INDIVIDUAL_DATAPOINT_LINE = LINE_THICKNESS/1.5
# SMALL_PLOTS_LINE_THICKNESS = LINE_THICKNESS/3
# cbPalette = c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#d55e00")
# treatment_colors = c('#0072B2', '#B9519E')

```

No need to run if chunk above has been run
```{r echo=TRUE}
library(ggplot2)
library(dplyr)
library(tidyr)
# install.packages(c('remotes', 'TMB'))
# remotes::install_github("glmmTMB/glmmTMB/glmmTMB", build_vignettes=FALSE)
library(glmmTMB)
library(DHARMa)
library(car)
library(reshape2)
library(emmeans)
library(rcompanion)
# Create the notin operator
`%notin%` <- Negate(`%in%`)

# Some global plot parameters if modification is needed.
source('./r_theme.r', echo=F)
theme_set(theme_mml(base_size = 20))
LINE_THICKNESS = 1
ERRORBAR_THICKNESS = LINE_THICKNESS/2
INDIVIDUAL_DATAPOINT_LINE = LINE_THICKNESS/1.5
SMALL_PLOTS_LINE_THICKNESS = LINE_THICKNESS/3

cbPalette = c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#d55e00")
treatment_colors = c('#0072B2', '#B9519E')

boxplot_whiskers <- function(x) {
  r <- quantile(x, probs = c(0.10, 0.25, 0.5, 0.75, 0.90))
  names(r) <- c("ymin", "lower", "middle", "upper", "ymax")
  r
}

# Custom functions
z_score = function(response_df, baseline_df) {
  
  # If variables have equal length, assume covariates, else don't use cov()
  if(length(response_df) == length(baseline_df)) {
    return(
      (mean(response_df) - mean(baseline_df)) / 
        (sqrt(var(response_df) + var(baseline_df) - 
        2*cov(response_df, baseline_df)))
    )
  } else {
    return(
      (mean(response_df) - mean(baseline_df)) / 
        (sqrt(var(response_df) + var(baseline_df)))
    )
  }
}


d_prime = function(response_df, baseline_df) {
  # Remove NaNs and NAs
  response_df = response_df[!(is.na(response_df) | is.nan(response_df))]
  baseline_df = baseline_df[!(is.na(baseline_df) | is.nan(baseline_df))]
  
  if( all(response_df == 0) & (all(baseline_df == 0))) {
    return(0)
  } else {
    d_numerator = 2 * (mean(response_df) - mean(baseline_df))
    d_denominator =  sd(response_df) + sd(baseline_df)
    return(d_numerator / d_denominator)
  }
}

cv = function(response_df) {
  return( 
      sd(response_df) / mean(response_df)
  )
}

zeromin = function(x) {
  return( (x + 2*abs(min(x))) )
}

# Create the notin operator
`%notin%` <- Negate(`%in%`)

### Load previously saved dataframe
df = read.csv('./Data/ACx_ephys/OFC-cannula_ACx-recording_allTrial_df.csv')
behavior_df = read.csv('./Data/ACx_ephys/OFC-cannula_ACx-recording_behavior_df.csv')

df[df == "NaN"]<-NA

# eliminate NA rows if they exist
df = df[!is.na(df$Subject),]

df$Session = factor(df$Session, levels=c('Pre', 'Active'))


df$Cluster_quality_Allen = 'mua'
df[(df$ISI_FPRate < 0.5) & (df$Fraction_missing < 0.1) & (df$Presence_ratio > 0.9) & (df$ISI_ViolationRate < 2),]$Cluster_quality_Allen = 'good'
df$Cluster_quality_Allen = factor(df$Cluster_quality_Allen, levels=c('good', 'mua'))
# Call 'good' the intersection between MML and Allen 
df$Cluster_quality = 'mua'
df[df$Cluster_quality_MML == 'good' & df$Cluster_quality_Allen == 'good',]$Cluster_quality = 'good'


# Rename trial type during passive session
df[df$Session != 'Active',]$Trial_type = 'Passive'

# Unit quality
df$Cluster_quality_Allen = 'mua'
df[(df$ISI_FPRate < 0.5) & (df$Fraction_missing < 0.1) & (df$Presence_ratio > 0.9) & (df$ISI_ViolationRate < 2),]$Cluster_quality_Allen = 'good'
df$Cluster_quality_Allen = factor(df$Cluster_quality_Allen, levels=c('good', 'mua'))
# Call 'good' the intersection between MML and Allen 
df$Cluster_quality = 'mua'
df[df$Cluster_quality_MML == 'good' & df$Cluster_quality_Allen == 'good',]$Cluster_quality = 'good'


# ---------------------------------------------------------------------------
# Data curation
# Exclude -9 dB days (different project)
df = df[df$Subject_date %notin% c('SUBJ-ID-448_230110', 'SUBJ-ID-448_230112'),]
behavior_df = behavior_df[!grepl('230110|230112', behavior_df$Session),]

# Did some passive playback during an active session for 448. Exclude here
df = df[!(df$Subject_date == 'SUBJ-ID-448_221213' & df$Trial_type == 'Miss (no shock)'),]

# In subject 174 Eliminate trials 75:end from PRE on the 11/16.
# Headstage battery died
df = df[!(df$Subject_date == 'SUBJ-ID-174_201116' & df$Session=='Pre' & df$TrialID >= 75 ),]


# SessionID 221210 was a shock training day (no treatment)  
# It accidentally made it into the behavioral dataset. Remove it here
behavior_df = behavior_df[!grepl('221210', behavior_df$Session),]

# Same for SUBJ-ID-575_230821
df = df[df$Subject_date != 'SUBJ-ID-575_230821',]
behavior_df = behavior_df[behavior_df$Subject_date != 'SUBJ-ID-575_230821',]

# Include only the first day of saline and muscimol for 448 and 575, which had repeated treatments
# SUBJ-ID-174 only had two days
df_all = df # Save all data here for repeated muscimol treatment analyses
behavior_df_all = behavior_df
good_subj_date = c('SUBJ-ID-448_221211', 'SUBJ-ID-448_221213')
good_subj_date = c(good_subj_date, 'SUBJ-ID-575_230826', 'SUBJ-ID-575_230827')
df = df[df$Subject == 'SUBJ-ID-174' | df$Subject_date %in% good_subj_date,]
behavior_df = behavior_df[behavior_df$Subject == 'SUBJ-ID-174' | behavior_df$Subject_date %in% good_subj_date,]
# ---------------------------------------------------------------------------

# Treatment days
df$Treatment = 'Saline'
muscimol_sessions = c('SUBJ-ID-174_201116')
muscimol_sessions = c(muscimol_sessions, 'SUBJ-ID-448_221213', 'SUBJ-ID-448_221215', 'SUBJ-ID-448_221217', 'SUBJ-ID-448_221219', 'SUBJ-ID-448_221220', 'SUBJ-ID-448_221222')
muscimol_sessions = c(muscimol_sessions, 'SUBJ-ID-575_230827', 'SUBJ-ID-575_230829', 'SUBJ-ID-575_230831', 'SUBJ-ID-575_230902')
df[df$Subject_date %in% muscimol_sessions,]$Treatment = 'Muscimol'
df$Treatment = factor(df$Treatment, levels=c('Saline', 'Muscimol'))

behavior_df$Treatment = 'Saline'
behavior_df[behavior_df$Subject_date %in% muscimol_sessions,]$Treatment = 'Muscimol'
behavior_df$Treatment = factor(behavior_df$Treatment, levels=c('Saline', 'Muscimol'))


save.image('./Data/ACx_ephys/ACx_ephys_analyses_env.RData')

# Some garbage collection
gc()
```

# Get some descriptives
```{r echo=TRUE}
# Training days per subject
df %>% group_by(Subject) %>%
  summarise(
    Max_day = length(unique(Day_of_training))
  )

# How many trials per session?
df_info = df[df$AMdepth_db != -40 & df$Period == 'Baseline',] %>% group_by(Subject, Session, Subject_date) %>%
  summarise(
    Trial_count = length(unique(TrialID))
  )
df_info %>% group_by(Session) %>%
  summarise(
    Trial_count_mean = mean(Trial_count),
    Trial_count_ste = sd(Trial_count)/sqrt(n() - 1)
  )

# How many single units?
df_info = df[df$AMdepth_db != -40 & df$Period == 'Baseline',] %>% group_by(Subject, Unit, Subject_date, Cluster_quality) %>%
  summarise(
    Trial_count = length(unique(TrialID)),
    ISI_FPRate = mean(ISI_FPRate),
    ISI_ViolationRate = mean(ISI_ViolationRate),
    Fraction_missing = mean(Fraction_missing)
  )
table(df_info$Cluster_quality)

# How many units per treatment?
df_info = df[df$AMdepth_db != -40 & df$Period == 'Baseline',] %>% group_by(Subject, Unit, Subject_date, Cluster_quality, Treatment) %>%
  summarise(
    Trial_count = length(unique(TrialID)),
    ISI_FPRate = mean(ISI_FPRate),
    ISI_ViolationRate = mean(ISI_ViolationRate),
    Fraction_missing = mean(Fraction_missing)
  )
table(df_info$Cluster_quality, df_info$Treatment)
```

# Figure 5C and S5: OFC muscimol's effect on behavior during ACx recordings
## Fig 5C: Behavioral d'
```{r echo=TRUE, fig.height=6, fig.width=3, warning=FALSE}
# Includes water consumption information
behavior_df$Treatment = factor(behavior_df$Treatment, levels=c('Saline', 'Muscimol'))

graph_data = behavior_df

y_axis = seq(0.5, 3, 0.5)
p = ggplot(data=graph_data, aes(x=Treatment, y=D_prime, color=Treatment, fill=Treatment)) + 
  stat_summary(fun.data=boxplot_whiskers, geom="boxplot", na.rm = T, alpha=0.25, lwd=LINE_THICKNESS/2, fatten=1, width=0.5)+

  geom_line(aes(group = Subject), color='black',  alpha=0.1, size=LINE_THICKNESS/4, width=0.1) +
  
  ylab('Behavioral d\'') +
  xlab('') +
  
  scale_fill_manual(name = "Treatment",
                   values = treatment_colors, guide='none') +
  scale_color_manual(name = "Treatment",
                   values = treatment_colors, guide='none') +
  
  scale_y_continuous(breaks=y_axis, expand=c(0, 0)) +
  coord_cartesian(ylim = c(min(y_axis), max(y_axis))) +
  
  annotate("text", x=1.5, y=2.8, label='Saline', color=treatment_colors[1], size=5, hjust=0) + 
  annotate("text", x=1.5, y=2.7, label='Muscimol', color=treatment_colors[2], size=5, hjust=0) + 
  
  theme(
    legend.position = 'none',
    axis.title.x=element_blank(),
    axis.line.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
p
# ggsave(plot=p, 'OFC-cannula_ACx-recording_behaviorDprime_lines.pdf', width=0.75, height=1.5,dpi=600, useDingbats=FALSE)
```

### Stats
```{r echo=TRUE}
lme_data = graph_data
lme_bin <- glmmTMB(D_prime~ Treatment +  (1|Subject) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # pass
Anova(lme_bin)
```

## Fig S5A: Hit rate
```{r echo=TRUE, fig.height=6, fig.width=3, warning=FALSE}
y_axis = seq(0, 100, 25)
p = ggplot(data=graph_data, aes(x=Treatment, y=Hit_rate, color=Treatment, fill=Treatment)) + 
  stat_summary(fun.data=boxplot_whiskers, geom="boxplot", na.rm = T, alpha=0.25, lwd=LINE_THICKNESS/2, fatten=1, width=0.5)+

  geom_line(aes(group = Subject), color='black',  alpha=0.1, size=LINE_THICKNESS/4, width=0.1) +
  
  ylab('Hit rate (%)') +
  xlab('') +
  
  scale_fill_manual(name = "Treatment",
                   values = treatment_colors, guide='none') +
  scale_color_manual(name = "Treatment",
                   values = treatment_colors, guide='none') +
  
  scale_y_continuous(breaks=y_axis, expand=c(0, 0)) +
  coord_cartesian(ylim = c(min(y_axis), max(y_axis))) +
  
  annotate("text", x=1.5, y=95, label='Saline', color=treatment_colors[1], size=5, hjust=0) + 
  annotate("text", x=1.5, y=91, label='Muscimol', color=treatment_colors[2], size=5, hjust=0) + 
  
  theme(
    legend.position = 'none',
    axis.title.x=element_blank(),
    axis.line.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
p
```

### Stats
```{r echo=TRUE}
lme_data = graph_data
lme_bin <- glmmTMB(Hit_rate~ Treatment +  (1|Subject) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # pass
Anova(lme_bin)
```

## Fig S5B: False alarm rate
```{r echo=TRUE, fig.height=6, fig.width=3, warning=FALSE}
y_axis = seq(0, 100, 25)
p = ggplot(data=graph_data, aes(x=Treatment, y=FA_rate, color=Treatment, fill=Treatment)) + 
  stat_summary(fun.data=boxplot_whiskers, geom="boxplot", na.rm = T, alpha=0.25, lwd=LINE_THICKNESS/2, fatten=1, width=0.5)+

  geom_line(aes(group = Subject), color='black',  alpha=0.1, size=LINE_THICKNESS/4, width=0.1) +
  
  ylab('False alarm rate (%)') +
  xlab('') +
  
  scale_fill_manual(name = "Treatment",
                   values = treatment_colors, guide='none') +
  scale_color_manual(name = "Treatment",
                   values = treatment_colors, guide='none') +
  
  scale_y_continuous(breaks=y_axis, expand=c(0, 0)) +
  coord_cartesian(ylim = c(min(y_axis), max(y_axis))) +
  
  annotate("text", x=1.5, y=75, label='Saline', color=treatment_colors[1], size=5, hjust=0) + 
  annotate("text", x=1.5, y=71, label='Muscimol', color=treatment_colors[2], size=5, hjust=0) + 
  
  theme(
    legend.position = 'none',
    axis.title.x=element_blank(),
    axis.line.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
p
```

### Stats
```{r echo=TRUE}
lme_data = graph_data
lme_bin <- glmmTMB(FA_rate~ Treatment +  (1|Subject) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # pass
Anova(lme_bin)
```

## Fig S5C: Water consumed
```{r echo=TRUE, fig.height=6, fig.width=3, warning=FALSE}
y_axis = seq(0.5, 1.1, 0.1)
p = ggplot(data=graph_data, aes(x=Treatment, y=WaterConsumed, color=Treatment, fill=Treatment)) + 
  stat_summary(fun.data=boxplot_whiskers, geom="boxplot", na.rm = T, alpha=0.25, lwd=LINE_THICKNESS/2, fatten=1, width=0.5)+

  geom_line(aes(group = Subject), color='black',  alpha=0.1, size=LINE_THICKNESS/4, width=0.1) +
  
  ylab('Water consumed (mL)') +
  xlab('') +
  
  scale_fill_manual(name = "Treatment",
                   values = treatment_colors, guide='none') +
  scale_color_manual(name = "Treatment",
                   values = treatment_colors, guide='none') +
  
  scale_y_continuous(breaks=y_axis, expand=c(0, 0)) +
  coord_cartesian(ylim = c(min(y_axis), max(y_axis))) +
  
  annotate("text", x=1.5, y=1.05, label='Saline', color=treatment_colors[1], size=5, hjust=0) + 
  annotate("text", x=1.5, y=1.03, label='Muscimol', color=treatment_colors[2], size=5, hjust=0) + 
  
  theme(
    legend.position = 'none',
    axis.title.x=element_blank(),
    axis.line.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
p
```

### Stats
```{r echo=TRUE}
lme_data = graph_data
lme_bin <- glmmTMB(WaterConsumed~ Treatment +  (1|Subject) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # pass
Anova(lme_bin)
```

# Figure 5E-F and S6: OFC muscimol's effect on behavior during ACx recordings
## Fig 5E: Neural d'
```{r echo=TRUE, fig.height=6, fig.width=5, warning=FALSE}
df_grouped = df[df$Trial_type %notin% c('False alarm'),] %>% group_by(Unit, Subject, Subject_date, Session, Treatment, AMdprime) %>%
  summarise( 
    FR_Hz_baseline = mean(FR_Hz[Period == 'Baseline']),
    FR_Hz_trial = mean(FR_Hz[Period == 'Trial']),
    absNeural_d_trial = abs(d_prime(FR_Hz[Period == 'Trial'], FR_Hz[Period == 'Baseline'])),
  )

df_grouped$Session = factor(df_grouped$Session, levels=c('Pre', 'Active'))
levels(df_grouped$Session) = c('Passive', 'Task')

df_grouped = df_grouped[!is.na(df_grouped$absNeural_d_trial),]
complete_case_units = Reduce(intersect, list(df_grouped[df_grouped$Session == 'Passive',]$Unit, df_grouped[df_grouped$Session == 'Task',]$Unit))
df_grouped = df_grouped[df_grouped$Unit %in% complete_case_units,]

graph_data = df_grouped

# Create Session.Treatment intersection for color scheme
graph_data$Session.Treatment = as.character(interaction(graph_data$Session, graph_data$Treatment))
graph_data[grepl('Passive', graph_data$Session.Treatment),]$Session.Treatment = 'Passive'
graph_data$Session.Treatment = factor(graph_data$Session.Treatment, levels=c('Passive', 'Task.Saline', 'Task.Muscimol'))
session.treatment_colors = c('black', treatment_colors)

y_axis = seq(0, 1.5, 0.5)
p =ggplot(data=graph_data, aes(x=Session, y=(absNeural_d_trial), fill=Session.Treatment, color=Session.Treatment)) + 
  facet_grid(.~Treatment) +

    stat_summary(fun.data=boxplot_whiskers, geom="boxplot", na.rm = T, alpha=0.25, lwd=LINE_THICKNESS/2, fatten=1, width=0.5)+
  ylab('|Neural d\'|') + xlab('Trial type') +
  
  scale_fill_manual(name = "",
                   values = session.treatment_colors) +
  scale_color_manual(name = "",
                   values = session.treatment_colors) +
  
  scale_y_continuous(breaks=y_axis, expand=c(0, 0)) +
  coord_cartesian(ylim = c(min(y_axis), max(y_axis))) +
    
  theme(legend.position = c(0.7, 0.95), 
      strip.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.title.x = element_blank(),
      panel.spacing.x = unit(1.5, "lines"))
p
```

### Stats
```{r echo=TRUE}
lme_data = graph_data[graph_data$Treatment == 'Saline',]
lme_bin <- glmmTMB(sqrt(absNeural_d_trial)~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # pass
Anova(lme_bin)

lme_data = graph_data[graph_data$Treatment == 'Muscimol',]
lme_bin <- glmmTMB((sqrt(absNeural_d_trial))~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # pass
Anova(lme_bin)
```

## Fig S6A: Non-AM firing rate
```{r echo=TRUE, fig.height=6, fig.width=5, warning=FALSE}
df_grouped = df[df$Period %in% c('Baseline','Trial') & df$Trial_type %notin% c('False alarm'),] %>% group_by(Unit, Subject, Session, Subject_date, Period, Cluster_quality, Treatment) %>%
  summarise( 
    FR_Hz = mean(FR_Hz)
  )

df_grouped$Period = factor(df_grouped$Period, levels=c('Baseline','Trial'))
df_grouped$Period = droplevels(df_grouped$Period)
levels(df_grouped$Period) = c('non-AM', 'AM')

df_grouped$Session = factor(df_grouped$Session, levels=c('Pre', 'Active'))
levels(df_grouped$Session) = c('Passive', 'Task')

graph_data = df_grouped[df_grouped$Period == 'non-AM',]
graph_data$Session.Treatment = as.character(interaction(graph_data$Session, graph_data$Treatment))
graph_data[grepl('Passive', graph_data$Session.Treatment),]$Session.Treatment = 'Passive'
graph_data$Session.Treatment = factor(graph_data$Session.Treatment, levels=c('Passive', 'Task.Saline', 'Task.Muscimol'))
session.treatment_colors = c('black', treatment_colors)

y_axis = seq(0, 15, 5)
p =ggplot(data=graph_data, aes(x=Session, y=FR_Hz, fill=Session.Treatment, color=Session.Treatment)) + 
  facet_grid(.~Treatment) +

    stat_summary(fun.data=boxplot_whiskers, geom="boxplot", na.rm = T, alpha=0.25, lwd=LINE_THICKNESS/2, fatten=1, width=0.5)+
  ylab('Firing rate (Hz)') + xlab('Trial type') +
  
  scale_fill_manual(name = "",
                   values = session.treatment_colors) +
  scale_color_manual(name = "",
                   values = session.treatment_colors) +
  
  scale_y_continuous(breaks=y_axis, expand=c(0, 0)) +
  coord_cartesian(ylim = c(min(y_axis), max(y_axis))) +
  
  theme(legend.position = c(0.7, 0.95), 
      strip.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.title.x = element_blank(),
      panel.spacing.x = unit(1.5, "lines"))
p
```

### Stats
```{r echo=TRUE}
lme_data = graph_data[graph_data$Treatment == 'Saline',]
lme_bin <- glmmTMB(sqrt(FR_Hz)~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # passAnova(lme_bin)
Anova(lme_bin)

lme_data = graph_data[graph_data$Treatment == 'Muscimol',]
lme_bin <- glmmTMB(sqrt(FR_Hz)~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # passAnova(lme_bin)
Anova(lme_bin)
```

## Fig S6B: AM firing rate
```{r echo=TRUE, fig.height=6, fig.width=5, warning=FALSE}
graph_data = df_grouped[df_grouped$Period == 'AM',]
graph_data$Session.Treatment = as.character(interaction(graph_data$Session, graph_data$Treatment))
graph_data[grepl('Passive', graph_data$Session.Treatment),]$Session.Treatment = 'Passive'
graph_data$Session.Treatment = factor(graph_data$Session.Treatment, levels=c('Passive', 'Task.Saline', 'Task.Muscimol'))
session.treatment_colors = c('black', treatment_colors)

y_axis = seq(0, 15, 5)
p =ggplot(data=graph_data, aes(x=Session, y=FR_Hz, fill=Session.Treatment, color=Session.Treatment)) + 
  facet_grid(.~Treatment) +

    stat_summary(fun.data=boxplot_whiskers, geom="boxplot", na.rm = T, alpha=0.25, lwd=LINE_THICKNESS/2, fatten=1, width=0.5)+
  ylab('Firing rate (Hz)') + xlab('Trial type') +
  
  scale_fill_manual(name = "",
                   values = session.treatment_colors) +
  scale_color_manual(name = "",
                   values = session.treatment_colors) +
  
  scale_y_continuous(breaks=y_axis, expand=c(0, 0)) +
  coord_cartesian(ylim = c(min(y_axis), max(y_axis))) +
  
  theme(legend.position = c(0.7, 0.95), 
      strip.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.title.x = element_blank(),
      panel.spacing.x = unit(1.5, "lines"))
p
```

### Stats
```{r echo=TRUE}
lme_data = graph_data[graph_data$Treatment == 'Saline',]
lme_bin <- glmmTMB(sqrt(FR_Hz)~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # passAnova(lme_bin)
Anova(lme_bin)

lme_data = graph_data[graph_data$Treatment == 'Muscimol',]
lme_bin <- glmmTMB(sqrt(FR_Hz)~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # passAnova(lme_bin)
Anova(lme_bin)
```

## Fig 5F: Delta firing rate (AM - non-AM)
```{r echo=TRUE, fig.height=6, fig.width=5, warning=FALSE}
df_grouped = df[df$Trial_type %notin% c('False alarm'),] %>% group_by(Unit, Subject, Session, Subject_date, Cluster_quality_Allen, Cluster_quality, Treatment, TrialID) %>%
  summarise( 
    FR_Hz_Pre_AM_delta = (FR_Hz[Period=='Trial'] - FR_Hz[Period=='Baseline'])
  )

levels(df_grouped$Session) = c('Passive', 'Task')

graph_data = df_grouped %>% group_by(Unit, Subject, Session, Subject_date, Cluster_quality_Allen, Cluster_quality, Treatment) %>%
  summarise(
    FR_Hz_Pre_AM_delta = mean(FR_Hz_Pre_AM_delta, na.rm=T)
  )
graph_data$Session.Treatment = as.character(interaction(graph_data$Session, graph_data$Treatment))
graph_data[grepl('Passive', graph_data$Session.Treatment),]$Session.Treatment = 'Passive'
graph_data$Session.Treatment = factor(graph_data$Session.Treatment, levels=c('Passive', 'Task.Saline', 'Task.Muscimol'))
session.treatment_colors = c('black', treatment_colors)

y_axis = seq(-4, 4, 2)
p =ggplot(data=graph_data, aes(x=Session, y=FR_Hz_Pre_AM_delta, fill=Session.Treatment, color=Session.Treatment)) + 
  facet_grid(.~Treatment) +

    stat_summary(fun.data=boxplot_whiskers, geom="boxplot", na.rm = T, alpha=0.25, lwd=LINE_THICKNESS/2, fatten=1, width=0.5)+
  ylab(expression(~Delta*'Firing rate (Hz) AM - non-AM')) + 
  xlab('Trial type') +
  
  scale_fill_manual(name = "",
                   values = session.treatment_colors) +
  scale_color_manual(name = "",
                   values = session.treatment_colors) +
  
  scale_y_continuous(breaks=y_axis, expand=c(0, 0)) +
  coord_cartesian(ylim = c(min(y_axis), max(y_axis))) +
  
  theme(legend.position = c(0.7, 0.95), 
      strip.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.title.x = element_blank(),
      panel.spacing.x = unit(1.5, "lines"))
p
```

### Stats
```{r echo=TRUE}
lme_data = graph_data[graph_data$Treatment == 'Saline',]
lme_bin <- glmmTMB(log(zeromin(FR_Hz_Pre_AM_delta))~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # passAnova(lme_bin)
Anova(lme_bin)

lme_data = graph_data[graph_data$Treatment == 'Muscimol',]
lme_bin <- glmmTMB(log(zeromin(FR_Hz_Pre_AM_delta))~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # passAnova(lme_bin)
Anova(lme_bin)
```

## Fig S6C: Non-AM firing rate variability (CV)
```{r echo=TRUE, fig.height=6, fig.width=5, warning=FALSE}
df_grouped = df[df$Period %in% c('Baseline','Trial') & df$Trial_type %notin% c('False alarm'),] %>% group_by(Unit, Subject, Subject_date, Session, Cluster_quality, Treatment) %>%
  summarise(
    FR_cv_baseline = cv(FR_Hz[Period == 'Baseline']),
    FR_cv_trial = cv(FR_Hz[Period == 'Trial']),
    FR_cv_sum = FR_cv_baseline+FR_cv_trial,
  )

levels(df_grouped$Session) = c('Passive', 'Task')

# Exclude units with NaN values in either session
graph_data = df_grouped[!is.nan(df_grouped$FR_cv_baseline),]
complete_case_units = Reduce(intersect, list(graph_data[graph_data$Session == 'Passive',]$Unit, graph_data[graph_data$Session == 'Task',]$Unit))
graph_data = graph_data[graph_data$Unit %in% complete_case_units,]

graph_data$Session.Treatment = as.character(interaction(graph_data$Session, graph_data$Treatment))
graph_data[grepl('Passive', graph_data$Session.Treatment),]$Session.Treatment = 'Passive'
graph_data$Session.Treatment = factor(graph_data$Session.Treatment, levels=c('Passive', 'Task.Saline', 'Task.Muscimol'))
session.treatment_colors = c('black', treatment_colors)

y_axis = seq(0, 3, 1)
p =ggplot(data=graph_data, aes(x=Session, y=FR_cv_baseline, fill=Session.Treatment, color=Session.Treatment)) + 
  facet_grid(.~Treatment) +

    stat_summary(fun.data=boxplot_whiskers, geom="boxplot", na.rm = T, alpha=0.25, lwd=LINE_THICKNESS/2, fatten=1, width=0.5)+
  ylab('Firing rate variability (CV)') + 
  xlab('Trial type') +
  
  scale_fill_manual(name = "",
                   values = session.treatment_colors) +
  scale_color_manual(name = "",
                   values = session.treatment_colors) +
  
  scale_y_continuous(breaks=y_axis, expand=c(0, 0)) +
  coord_cartesian(ylim = c(min(y_axis), max(y_axis))) +
  
  theme(legend.position = c(0.7, 0.95), 
      strip.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.title.x = element_blank(),
      panel.spacing.x = unit(1.5, "lines"))
p
```

### Stats
```{r echo=TRUE}
lme_data = graph_data[graph_data$Treatment == 'Saline',]
lme_bin <- glmmTMB(log((FR_cv_baseline))~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # passAnova(lme_bin)
Anova(lme_bin)

lme_data = graph_data[graph_data$Treatment == 'Muscimol',]
lme_bin <- glmmTMB(log((FR_cv_baseline))~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # passAnova(lme_bin)
Anova(lme_bin)
```

## Fig S6D: AM firing rate variability (CV)
```{r echo=TRUE, fig.height=6, fig.width=5, warning=FALSE}
graph_data = df_grouped[!is.nan(df_grouped$FR_cv_trial),]
complete_case_units = Reduce(intersect, list(graph_data[graph_data$Session == 'Passive',]$Unit, graph_data[graph_data$Session == 'Task',]$Unit))
graph_data = graph_data[graph_data$Unit %in% complete_case_units,]

graph_data$Session.Treatment = as.character(interaction(graph_data$Session, graph_data$Treatment))
graph_data[grepl('Passive', graph_data$Session.Treatment),]$Session.Treatment = 'Passive'
graph_data$Session.Treatment = factor(graph_data$Session.Treatment, levels=c('Passive', 'Task.Saline', 'Task.Muscimol'))
session.treatment_colors = c('black', treatment_colors)

y_axis = seq(0, 3, 1)
p =ggplot(data=graph_data, aes(x=Session, y=FR_cv_trial, fill=Session.Treatment, color=Session.Treatment)) + 
  facet_grid(.~Treatment) +

    stat_summary(fun.data=boxplot_whiskers, geom="boxplot", na.rm = T, alpha=0.25, lwd=LINE_THICKNESS/2, fatten=1, width=0.5)+
  ylab('Firing rate variability (CV)') + 
  xlab('Trial type') +
  
  scale_fill_manual(name = "",
                   values = session.treatment_colors) +
  scale_color_manual(name = "",
                   values = session.treatment_colors) +
  
  scale_y_continuous(breaks=y_axis, expand=c(0, 0)) +
  coord_cartesian(ylim = c(min(y_axis), max(y_axis))) +
  
  theme(legend.position = c(0.7, 0.95), 
      strip.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.title.x = element_blank(),
      panel.spacing.x = unit(1.5, "lines"))
p
```

### Stats
```{r echo=TRUE}
lme_data = graph_data[graph_data$Treatment == 'Saline',]
lme_bin <- glmmTMB(log((FR_cv_trial))~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # passAnova(lme_bin)
Anova(lme_bin)

lme_data = graph_data[graph_data$Treatment == 'Muscimol',]
lme_bin <- glmmTMB(log((FR_cv_trial))~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # passAnova(lme_bin)
Anova(lme_bin)
```

## Fig 5G: Pooled firing rate variability (CV; non-AM + AM)
```{r echo=TRUE, fig.height=6, fig.width=5, warning=FALSE}
graph_data = df_grouped[!is.nan(df_grouped$FR_cv_sum),]
complete_case_units = Reduce(intersect, list(graph_data[graph_data$Session == 'Passive',]$Unit, graph_data[graph_data$Session == 'Task',]$Unit))
graph_data = graph_data[graph_data$Unit %in% complete_case_units,]

graph_data$Session.Treatment = as.character(interaction(graph_data$Session, graph_data$Treatment))
graph_data[grepl('Passive', graph_data$Session.Treatment),]$Session.Treatment = 'Passive'
graph_data$Session.Treatment = factor(graph_data$Session.Treatment, levels=c('Passive', 'Task.Saline', 'Task.Muscimol'))
session.treatment_colors = c('black', treatment_colors)

y_axis = seq(0, 5, 1)
p =ggplot(data=graph_data, aes(x=Session, y=FR_cv_sum, fill=Session.Treatment, color=Session.Treatment)) + 
  facet_grid(.~Treatment) +

    stat_summary(fun.data=boxplot_whiskers, geom="boxplot", na.rm = T, alpha=0.25, lwd=LINE_THICKNESS/2, fatten=1, width=0.5)+
  ylab('Firing rate variability (CV)') + 
  xlab('Trial type') +
  
  scale_fill_manual(name = "",
                   values = session.treatment_colors) +
  scale_color_manual(name = "",
                   values = session.treatment_colors) +
  
  scale_y_continuous(breaks=y_axis, expand=c(0, 0)) +
  coord_cartesian(ylim = c(min(y_axis), max(y_axis))) +
  
  theme(legend.position = c(0.7, 0.95), 
      strip.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.title.x = element_blank(),
      panel.spacing.x = unit(1.5, "lines"))
p
```

### Stats
```{r echo=TRUE}
lme_data = graph_data[graph_data$Treatment == 'Saline',]
lme_bin <- glmmTMB(sqrt((FR_cv_sum))~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # passAnova(lme_bin)
Anova(lme_bin)

lme_data = graph_data[graph_data$Treatment == 'Muscimol',]
lme_bin <- glmmTMB(sqrt((FR_cv_sum))~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # passAnova(lme_bin)
Anova(lme_bin)
```

## Fig 5H: Vector strength
```{r echo=TRUE, fig.height=6, fig.width=5, warning=FALSE}
# Load VS data and merge to existent df
vs_df = read.csv('./Data/ACx_ephys/OFC-cannula_ACx-recording_allTrial_VS.csv')
vs_df$Session = 'Pre'
vs_df[grepl('Aversive|Active', vs_df$SessionID),]$Session = 'Active'

df = merge(df, vs_df, by=c('Unit', 'Session', 'Period'))
remove(vs_df)

df_grouped = df %>% group_by(Unit, Subject, Subject_date, Session, Cluster_quality_Allen, Cluster_quality, Treatment) %>%
  summarise( 
    VSpp_baseline = mean(VSpp[Period == 'Baseline'], na.rm=T),
    VSpp_trial = mean(VSpp[Period == 'Trial'], na.rm=T)
  )

df_grouped$Session = factor(df_grouped$Session, levels=c('Pre', 'Active'))
levels(df_grouped$Session) = c('Passive', 'Task')

# # Only include units with both Passive and Task values
graph_data = df_grouped[!is.nan(df_grouped$VSpp_trial),]
complete_case_units = Reduce(intersect, list(graph_data[graph_data$Session == 'Passive',]$Unit, graph_data[df_grouped$Session == 'Task',]$Unit))
graph_data = graph_data[graph_data$Unit %in% complete_case_units,]

graph_data$Session.Treatment = as.character(interaction(graph_data$Session, graph_data$Treatment))
graph_data[grepl('Passive', graph_data$Session.Treatment),]$Session.Treatment = 'Passive'
graph_data$Session.Treatment = factor(graph_data$Session.Treatment, levels=c('Passive', 'Task.Saline', 'Task.Muscimol'))
session.treatment_colors = c('black', treatment_colors)

y_axis = seq(0, 0.3, 0.1)
p =ggplot(data=graph_data, aes(x=Session, y=VSpp_trial, fill=Session.Treatment, color=Session.Treatment)) + 
  facet_grid(.~Treatment) +

    stat_summary(fun.data=boxplot_whiskers, geom="boxplot", na.rm = T, alpha=0.25, lwd=LINE_THICKNESS/2, fatten=1, width=0.5)+
  ylab('Firing rate variability (CV)') + 
  xlab('Trial type') +
  
  scale_fill_manual(name = "",
                   values = session.treatment_colors) +
  scale_color_manual(name = "",
                   values = session.treatment_colors) +
  
  scale_y_continuous(breaks=y_axis, expand=c(0, 0)) +
  coord_cartesian(ylim = c(min(y_axis), max(y_axis))) +
  
  theme(legend.position = c(0.3, 0.2), 
      strip.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.title.x = element_blank(),
      panel.spacing.x = unit(1.5, "lines"))
p
```

### Stats
```{r echo=TRUE}
lme_data = graph_data[graph_data$Treatment == 'Saline',]
lme_bin <- glmmTMB(VSpp_trial*10~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # pass
Anova(lme_bin)

lme_data = graph_data[graph_data$Treatment == 'Muscimol',]
lme_bin <- glmmTMB(VSpp_trial~ Session +  (1|Subject/Unit/Session) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # pass
Anova(lme_bin)

```

# Figure 6: Repeated OFC muscimol treatment's effect on behavior during ACx recordings
## Fig 6A: Behavior
```{r echo=TRUE, fig.height=6, fig.width=7, warning=FALSE}
# Retrieve all day data
df = df_all
behavior_df = behavior_df_all

# Include only 448 and 575, the ones with repeated muscimol administration
good_subj = c('SUBJ-ID-448', 'SUBJ-ID-575')
df = df[df$Subject %in% good_subj,]
behavior_df = behavior_df[behavior_df$Subject %in% good_subj,]

# Treatment days
df$Treatment = 'Saline'
muscimol_1x_sessions = c('SUBJ-ID-448_221213', 'SUBJ-ID-448_221215')
muscimol_2x_sessions = c('SUBJ-ID-448_221217', 'SUBJ-ID-448_221219', 'SUBJ-ID-448_221220', 'SUBJ-ID-448_221222')
muscimol_1x_sessions = c(muscimol_1x_sessions, 'SUBJ-ID-575_230827', 'SUBJ-ID-575_230829', 'SUBJ-ID-575_230831')
muscimol_2x_sessions = c(muscimol_2x_sessions, 'SUBJ-ID-575_230902')
df[df$Subject_date %in% muscimol_1x_sessions,]$Treatment = 'Muscimol_1x'
df[df$Subject_date %in% muscimol_2x_sessions,]$Treatment = 'Muscimol_2x'
df$Treatment = factor(df$Treatment, levels=c('Saline', 'Muscimol_1x', 'Muscimol_2x'))

df$Treatment_noDose = 'Saline'
df[df$Subject_date %in% muscimol_1x_sessions,]$Treatment_noDose = 'Muscimol'
df[df$Subject_date %in% muscimol_2x_sessions,]$Treatment_noDose = 'Muscimol'
df$Treatment_noDose = factor(df$Treatment_noDose, levels=c('Saline', 'Muscimol'))

behavior_df$Treatment = 'Saline'
behavior_df[behavior_df$Subject_date %in% muscimol_1x_sessions,]$Treatment = 'Muscimol_1x'
behavior_df[behavior_df$Subject_date %in% muscimol_2x_sessions,]$Treatment = 'Muscimol_2x'
behavior_df$Treatment = factor(behavior_df$Treatment, levels=c('Saline', 'Muscimol_1x', 'Muscimol_2x'))

behavior_df$Treatment_noDose = 'Saline'
behavior_df[behavior_df$Subject_date %in% muscimol_1x_sessions,]$Treatment_noDose = 'Muscimol'
behavior_df[behavior_df$Subject_date %in% muscimol_2x_sessions,]$Treatment_noDose = 'Muscimol'
behavior_df$Treatment_noDose = factor(behavior_df$Treatment_noDose, levels=c('Saline', 'Muscimol'))

graph_data = behavior_df

treatmentDose_colors = c("#0072B2", "#EECBE1", "#B9519E")
y_axis = seq(0.5, 3.5, 0.5)
x_axis = c(1, 5, 7, 10)
p = ggplot(data=graph_data, aes(x=Day, y=D_prime, fill=Treatment, color=Treatment_noDose)) + 
  
  geom_line(aes(group = Subject), alpha=0.3, size=LINE_THICKNESS, color='black') +
  geom_point(aes(group = Subject),  alpha=1, size=LINE_THICKNESS*4, shape=21) +
  facet_grid(.~Subject) +

  ylab('Behavioral d\'') + xlab('Day') +
  scale_fill_manual(name = "",
                   values = treatmentDose_colors, labels=c('Saline', 'Muscimol 1 mg/mL', 'Muscimol 2 mg/mL')) +
  scale_color_manual(name = "",
                   values = treatment_colors, guide='none') +
  
  scale_y_continuous(breaks=y_axis, expand=c(0, 0)) +
  scale_x_continuous(breaks=x_axis) +
  coord_cartesian(ylim = c(min(y_axis), max(y_axis))) +
  
  theme(legend.position = c(0.25, 0.15))
p

```

## Fig 6B: Correlation between behavioral and neural d'
```{r, fig.height=6, fig.width=6, warning=FALSE}

df_grouped = df[df$Trial_type %notin% c('False alarm') & df$Session == 'Active' & df$Period %in% c('Trial', 'Baseline') & df$Treatment_noDose %in% c('Saline','Muscimol'),] %>% group_by(Unit, Subject, Date, Subject_date, Treatment_noDose) %>%
  summarise( 
    Neural_dprime = d_prime(FR_Hz[Period == 'Trial'], FR_Hz[Period == 'Baseline']),
    Behavioral_dprime = mean(AMdprime)
  )

graph_data = df_grouped
graph_means = graph_data %>% group_by(Behavioral_dprime, Treatment_noDose) %>%
  summarise(
    absNeural_dprime = mean(abs(Neural_dprime))
  )

y_axis = seq(0, 3, 1)
x_axis = seq(1, 3, 1)
p =ggplot(data=graph_data, aes(x=Behavioral_dprime, y=abs(Neural_dprime), fill=Treatment_noDose)) + 
  geom_point(size=LINE_THICKNESS*2,
             shape=21,
             color='NA',
             alpha=0.3) +

    stat_smooth(method = "lm", se = T,  alpha=0.1, size=LINE_THICKNESS, formula=y~x, color='black', fill='black', aes(group=1)) +
    geom_point(data=graph_means, aes(x=Behavioral_dprime, y=absNeural_dprime),
               size=LINE_THICKNESS*3,
               shape=21,
               color='NA',
               fill='black',
               alpha=1) +
  scale_fill_manual(name = "Treatment", values = treatment_colors) +
  scale_color_manual(name = "Treatment",
                   values = treatment_colors) +
  ylab('|Task Neural d\'|') + xlab('Behavioral d\'') +
  
  scale_y_continuous(breaks=y_axis, expand=c(0, 0)) +
  scale_x_continuous(breaks=y_axis) +
  coord_cartesian(ylim = c(min(y_axis)-0.5, max(y_axis))) +
  
   theme(legend.position = "none",
         strip.text.x = element_blank())
p
```

### Stats
```{r echo=TRUE}
lme_data = graph_data
lme_bin <- glmmTMB(sqrt(abs(Neural_dprime))*10~ Behavioral_dprime +  (1|Subject/Behavioral_dprime/Unit) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # pass
Anova(lme_bin)
```

## Fig 6C: Behavioral performance vs Neural d'
```{r, fig.height=6, fig.width=3, warning=FALSE}
# Label two best days and two worst days as good and bad performance respectively
df_grouped$Behavioral_performance = ''

good_behavior = c('221221', '221216', '230901', '230902')
poor_behavior = c('221213', '221217', '230827', '230829')
df_grouped[df_grouped$Date %in% good_behavior,]$Behavioral_performance = 'good'
df_grouped[df_grouped$Date %in% poor_behavior,]$Behavioral_performance = 'poor'
df_grouped = df_grouped[df_grouped$Behavioral_performance %in% c('poor','good'),]

df_grouped$Behavioral_performance = factor(df_grouped$Behavioral_performance, levels=c('poor', 'good'))

graph_data = df_grouped

y_axis = seq(0, 2, 1)
p =ggplot(data=graph_data, aes(x=Behavioral_performance, y=abs(Neural_dprime))) + 
  stat_summary(fun.data=boxplot_whiskers, geom="boxplot", na.rm = T, alpha=0.3, lwd=LINE_THICKNESS, fatten=1, width=0.5, fill='black')+ 
  ylab('|Task neural d\'|') + xlab('Behavioral\nperformance') +
  scale_y_continuous(breaks=y_axis, expand=c(0, 0)) +
  coord_cartesian(ylim = c(min(y_axis), max(y_axis))) +
    theme(
    legend.position = 'none',
    axis.line.x = element_blank(),
    axis.ticks.x=element_blank()
    ) 
p
```

### Stats
```{r echo=TRUE}
lme_data = graph_data
lme_bin <- glmmTMB(sqrt((abs(Neural_dprime)))~ Behavioral_performance +  (1|Subject/Behavioral_performance/Unit) , data=lme_data, family=gaussian)
simulationOutput <- simulateResiduals(fittedModel = lme_bin, plot = T, re.form=NULL)  # pass
Anova(lme_bin)
```